name: Lint & Format

# Run linting checks on pull requests
# Validates Python, PowerShell, and Shell scripts for code quality and best practices
on:
  pull_request:
    branches: [ "main", "dev" ]
    paths:
      # Python files
      - '**/*.py'
      # PowerShell files
      - '**/*.ps1'
      - '**/*.psm1'
      - '**/*.psd1'
      # Shell scripts
      - '**/*.sh'
      # Linter configuration files
      - '.flake8'
      - 'pyproject.toml'
      - 'setup.cfg'
      - '.shellcheckrc'
  workflow_dispatch:  # Allow manual triggers
  workflow_call:

jobs:
  lint-python:
    name: Lint Python
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      pull-requests: write  # For commenting on PRs

    steps:
      # Step 1: Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Check if Python files exist
      - name: Check for Python files
        id: check-python
        shell: bash
        run: |
          if find . -type f -name "*.py" | grep -q .; then
            echo "has_python_files=true" >> $GITHUB_OUTPUT
          else
            echo "has_python_files=false" >> $GITHUB_OUTPUT
            echo "## ðŸ Python Linting" >> $GITHUB_STEP_SUMMARY
            echo "No Python files found to lint" >> $GITHUB_STEP_SUMMARY
          fi

      # Step 3: Set up Python with caching
      - name: Setup Python
        if: steps.check-python.outputs.has_python_files == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"
          cache: 'pip'
          cache-dependency-path: |
            **/requirements*.txt
            **/pyproject.toml

      # Step 4: Install Python linters and formatters
      - name: Install Python linters
        if: steps.check-python.outputs.has_python_files == 'true'
        shell: bash
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort
          
          # Install project dependencies if they exist (for better linting)
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      # Step 5: Run flake8 (style guide enforcement)
      - name: Run flake8
        if: steps.check-python.outputs.has_python_files == 'true'
        id: flake8
        shell: bash
        run: |
          set +e  # Don't exit on error immediately
          
          echo "## ðŸ Python Linting Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Run flake8 for critical errors only
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics > flake8-critical.txt 2>&1
          critical_exit=$?
          
          if [ $critical_exit -eq 0 ]; then
            echo "âœ… No critical errors found" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Critical errors found:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat flake8-critical.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          
          # Run full flake8 check (warnings, style issues)
          flake8 . --count --max-complexity=10 --max-line-length=127 --statistics > flake8-full.txt 2>&1
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š Full flake8 report (last 20 lines):" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -20 flake8-full.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          # Exit with critical error code
          exit $critical_exit

      # Step 6: Check code formatting with Black
      - name: Check Black formatting
        if: steps.check-python.outputs.has_python_files == 'true' && always()
        id: black
        shell: bash
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Black Code Formatting" >> $GITHUB_STEP_SUMMARY
          
          if black --check --diff . > black-report.txt 2>&1; then
            echo "âœ… All Python files are properly formatted" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Files need formatting:" >> $GITHUB_STEP_SUMMARY
            echo '```diff' >> $GITHUB_STEP_SUMMARY
            head -50 black-report.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ’¡ Run \`black .\` to auto-format" >> $GITHUB_STEP_SUMMARY
          fi
        continue-on-error: true  # Don't fail on formatting issues

      # Step 7: Check import sorting with isort
      - name: Check isort
        if: steps.check-python.outputs.has_python_files == 'true' && always()
        id: isort
        shell: bash
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Import Sorting (isort)" >> $GITHUB_STEP_SUMMARY
          
          if isort --check-only --diff . > isort-report.txt 2>&1; then
            echo "âœ… All imports are properly sorted" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Imports need sorting" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ’¡ Run \`isort .\` to auto-sort" >> $GITHUB_STEP_SUMMARY
          fi
        continue-on-error: true

      # Step 8: Upload lint reports as artifacts
      - name: Upload Python lint reports
        if: always() && steps.check-python.outputs.has_python_files == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: python-lint-reports
          path: |
            flake8-*.txt
            black-report.txt
            isort-report.txt
          retention-days: 30
          if-no-files-found: ignore

  lint-powershell:
    name: Lint PowerShell
    runs-on: windows-latest  # Use Windows for better PowerShell support
    timeout-minutes: 10
    permissions:
      contents: read
      pull-requests: write

    steps:
      # Step 1: Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Install and run PSScriptAnalyzer
      - name: PowerShell ScriptAnalyzer
        shell: pwsh
        run: |
          # Install PSScriptAnalyzer
          Write-Host "Installing PSScriptAnalyzer..."
          Install-Module PSScriptAnalyzer -Force -Scope CurrentUser -Repository PSGallery
          
          # Find all PowerShell files
          $psFiles = Get-ChildItem -Recurse -Include *.ps1,*.psm1,*.psd1 -ErrorAction SilentlyContinue | Where-Object { $_.FullName -notmatch 'node_modules|\.git' }
          
          if ($psFiles.Count -eq 0) {
            Write-Host "No PowerShell files found to analyze"
            "## ðŸ”· PowerShell Linting Results`n`nNo PowerShell files found to analyze" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8
            exit 0
          }
          
          Write-Host "Found $($psFiles.Count) PowerShell files to analyze"
          
          # Run analysis
          $results = $psFiles | ForEach-Object {
            Invoke-ScriptAnalyzer -Path $_.FullName -Severity Warning,Error,Information
          }
          
          # Generate report
          $errors = $results | Where-Object { $_.Severity -eq 'Error' }
          $warnings = $results | Where-Object { $_.Severity -eq 'Warning' }
          $info = $results | Where-Object { $_.Severity -eq 'Information' }
          
          # Create summary
          $summary = @"
          ## ðŸ”· PowerShell Linting Results
          
          **Files Analyzed:** $($psFiles.Count)
          
          - ðŸ”´ **Errors:** $($errors.Count)
          - ðŸŸ¡ **Warnings:** $($warnings.Count)
          - ðŸ”µ **Information:** $($info.Count)
          
          "@ | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8
          
          # Add details if issues found
          if ($errors.Count -gt 0) {
            "### âŒ Errors`n" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
            $errors | ForEach-Object {
              "- **$($_.RuleName)** in ``$($_.ScriptName)`` (Line $($_.Line)): $($_.Message)" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
            }
          }
          
          if ($warnings.Count -gt 0) {
            "`n### âš ï¸ Warnings (First 10)`n" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
            $warnings | Select-Object -First 10 | ForEach-Object {
              "- **$($_.RuleName)** in ``$($_.ScriptName)`` (Line $($_.Line)): $($_.Message)" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
            }
          }
          
          # Save full report
          if ($results.Count -gt 0) {
            $results | Export-Csv -Path "pssa-report.csv" -NoTypeInformation
          }
          
          # Exit with error if critical issues found
          if ($errors.Count -gt 0) {
            Write-Error "PSScriptAnalyzer found $($errors.Count) error(s)"
            exit 1
          }

      # Step 3: Upload PSScriptAnalyzer report
      - name: Upload PowerShell lint report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: powershell-lint-report
          path: pssa-report.csv
          retention-days: 30
          if-no-files-found: ignore

  lint-shell:
    name: Lint Shell Scripts
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read

    steps:
      # Step 1: Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Check if shell scripts exist
      - name: Check for shell scripts
        id: check-shell
        shell: bash
        run: |
          if find . -type f -name "*.sh" | grep -q .; then
            echo "has_shell_scripts=true" >> $GITHUB_OUTPUT
          else
            echo "has_shell_scripts=false" >> $GITHUB_OUTPUT
            echo "## ðŸš Shell Script Linting" >> $GITHUB_STEP_SUMMARY
            echo "No shell scripts found to lint" >> $GITHUB_STEP_SUMMARY
          fi

      # Step 3: Run ShellCheck
      - name: Run ShellCheck
        if: steps.check-shell.outputs.has_shell_scripts == 'true'
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: '.'
          severity: warning
          format: gcc

      # Step 4: Generate ShellCheck summary
      - name: ShellCheck summary
        if: steps.check-shell.outputs.has_shell_scripts == 'true' && always()
        shell: bash
        run: |
          echo "## ðŸš Shell Script Linting" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… ShellCheck analysis completed" >> $GITHUB_STEP_SUMMARY
          echo "Review the logs above for any issues found" >> $GITHUB_STEP_SUMMARY

  lint-summary:
    name: Lint Summary
    runs-on: ubuntu-latest
    needs: [lint-python, lint-powershell, lint-shell]
    if: always()
    permissions:
      contents: read

    steps:
      - name: Generate overall summary
        shell: bash
        run: |
          echo "## ðŸ“‹ Overall Linting Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          python_result="${{ needs.lint-python.result }}"
          powershell_result="${{ needs.lint-powershell.result }}"
          shell_result="${{ needs.lint-shell.result }}"
          
          # Display results with appropriate icons
          case "$python_result" in
            "success") echo "- ðŸ **Python:** âœ… Passed" >> $GITHUB_STEP_SUMMARY ;;
            "failure") echo "- ðŸ **Python:** âŒ Failed" >> $GITHUB_STEP_SUMMARY ;;
            "skipped") echo "- ðŸ **Python:** â­ï¸ Skipped" >> $GITHUB_STEP_SUMMARY ;;
            *) echo "- ðŸ **Python:** âš ï¸ $python_result" >> $GITHUB_STEP_SUMMARY ;;
          esac
          
          case "$powershell_result" in
            "success") echo "- ðŸ”· **PowerShell:** âœ… Passed" >> $GITHUB_STEP_SUMMARY ;;
            "failure") echo "- ðŸ”· **PowerShell:** âŒ Failed" >> $GITHUB_STEP_SUMMARY ;;
            "skipped") echo "- ðŸ”· **PowerShell:** â­ï¸ Skipped" >> $GITHUB_STEP_SUMMARY ;;
            *) echo "- ðŸ”· **PowerShell:** âš ï¸ $powershell_result" >> $GITHUB_STEP_SUMMARY ;;
          esac
          
          case "$shell_result" in
            "success") echo "- ðŸš **Shell:** âœ… Passed" >> $GITHUB_STEP_SUMMARY ;;
            "failure") echo "- ðŸš **Shell:** âŒ Failed" >> $GITHUB_STEP_SUMMARY ;;
            "skipped") echo "- ðŸš **Shell:** â­ï¸ Skipped" >> $GITHUB_STEP_SUMMARY ;;
            *) echo "- ðŸš **Shell:** âš ï¸ $shell_result" >> $GITHUB_STEP_SUMMARY ;;
          esac
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Determine overall status (ignore skipped jobs)
          if [ "$python_result" == "failure" ] || [ "$powershell_result" == "failure" ] || [ "$shell_result" == "failure" ]; then
            echo "âŒ **Overall Status:** One or more linting checks failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âœ… **Overall Status:** All linting checks passed" >> $GITHUB_STEP_SUMMARY
          fi