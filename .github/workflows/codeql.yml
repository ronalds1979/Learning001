name: CodeQL Security Analysis

# Triggers: push/PR on main+dev, weekly schedule, and manual runs.
on:
  push:
    branches: ['main', 'dev']
    paths-ignore:
      # Skip runs on docs/text-only changes.
      - '**/*.md'
      - 'docs/**'
      - '**/*.txt'
      - '.gitignore'
      - 'LICENSE'
  pull_request:
    branches: ['main', 'dev']
    paths-ignore:
      # Same exclusions for PRs.
      - '**/*.md'
      - 'docs/**'
      - '**/*.txt'
      - '.gitignore'
      - 'LICENSE'
  schedule:
    # Weekly scan Monday 02:00 UTC.
    - cron: '0 2 * * 1'
  workflow_dispatch:

jobs:
  analyze:
    name: CodeQL Analysis (${{ matrix.language }})
    runs-on: ubuntu-latest
    timeout-minutes: 45

    # Least-privilege permissions for CodeQL upload.
    permissions:
      actions: read
      contents: read
      security-events: write
      pull-requests: write

    strategy:
      # Keep matrix running even if one language fails.
      fail-fast: false
      matrix:
        language: ['python', 'javascript']

    steps:
      # ============================================================
      # 1) Checkout
      # ============================================================
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Full history for schedule, shallow clone otherwise.
          fetch-depth: ${{ github.event_name == 'schedule' && 0 || 1 }}

      # ============================================================
      # 2) Python setup
      # ============================================================
      - name: Set up Python (with pip cache)
        if: >-
          matrix.language == 'python' &&
          hashFiles('**/requirements.txt', '**/requirements-dev.txt', '**/pyproject.toml') != ''
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
          cache: 'pip'
          cache-dependency-path: |
            **/requirements.txt
            **/requirements-dev.txt
            **/pyproject.toml

      - name: Set up Python (no cache)
        if: >-
          matrix.language == 'python' &&
          hashFiles('**/requirements.txt', '**/requirements-dev.txt', '**/pyproject.toml') == ''
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      # Install Python dependencies (monorepo-aware).
      - name: Install Python dependencies
        if: >-
          matrix.language == 'python' &&
          (hashFiles('**/requirements*.txt') != '' || hashFiles('**/pyproject.toml') != '')
        shell: bash
        run: |
          set -euo pipefail

          # Upgrade pip to latest version for best compatibility.
          python -m pip install --upgrade pip

          # Discover manifests recursively, skipping generated/dependency folders.
          mapfile -t requirement_files < <(find . -type f \( -name 'requirements.txt' -o -name 'requirements-dev.txt' \) \
            ! -path '*/.git/*' \
            ! -path '*/.venv/*' \
            ! -path '*/venv/*' \
            ! -path '*/env/*' \
            ! -path '*/node_modules/*' \
            ! -path '*/dist/*' \
            ! -path '*/build/*' | sort)
          mapfile -t pyproject_files < <(find . -type f -name 'pyproject.toml' \
            ! -path '*/.git/*' \
            ! -path '*/.venv/*' \
            ! -path '*/venv/*' \
            ! -path '*/env/*' \
            ! -path '*/node_modules/*' \
            ! -path '*/dist/*' \
            ! -path '*/build/*' | sort)

          poetry_installed="false"

          # Install requirements files first, grouped by directory.
          declare -A requirement_dirs=()
          for req_file in "${requirement_files[@]:-}"; do
            req_dir="$(dirname "$req_file")"
            requirement_dirs["$req_dir"]=1
          done

          for req_dir in "${!requirement_dirs[@]}"; do
            echo "Installing Python requirements in $req_dir"
            pushd "$req_dir" >/dev/null
            if [ -f requirements.txt ]; then
              pip install -r requirements.txt
            fi
            if [ -f requirements-dev.txt ]; then
              pip install -r requirements-dev.txt
            fi
            popd >/dev/null
          done

          # Fallback to pyproject for directories without requirements files.
          for pyproject_file in "${pyproject_files[@]:-}"; do
            project_dir="$(dirname "$pyproject_file")"

            if [ -f "$project_dir/requirements.txt" ] || \
               [ -f "$project_dir/requirements-dev.txt" ]; then
              continue
            fi

            echo "Installing Python project from $project_dir/pyproject.toml"
            pushd "$project_dir" >/dev/null
            if grep -q '^\[tool\.poetry\]' pyproject.toml; then
              if [ "$poetry_installed" = "false" ]; then
                python -m pip install poetry
                poetry_installed="true"
              fi
              poetry config virtualenvs.create false
              poetry install --no-interaction --no-root
            else
              pip install .
            fi
            popd >/dev/null
          done
        continue-on-error: true

      # ============================================================
      # 3) Node.js setup
      # ============================================================
      - name: Set up Node.js
        if: matrix.language == 'javascript'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          # Cache based on lockfile presence.
          cache: >-
            ${{ hashFiles('**/pnpm-lock.yaml') != '' && 'pnpm' ||
            (hashFiles('**/yarn.lock') != '' && 'yarn' ||
            (hashFiles('**/package-lock.json') != '' && 'npm' || null)) }}

      # Install Node.js dependencies (monorepo-aware).
      - name: Install Node.js dependencies
        if: >-
          matrix.language == 'javascript' &&
          hashFiles('**/package.json') != ''
        shell: bash
        run: |
          set -euo pipefail

          # Enable package manager shims (pnpm/yarn) via Corepack when available.
          corepack enable || true

          is_root_workspace="false"
          if [ -f package.json ] && grep -q '"workspaces"' package.json; then
            is_root_workspace="true"
          fi

          # Workspace root install: pnpm.
          if [ -f pnpm-workspace.yaml ] || \
             { [ "$is_root_workspace" = "true" ] && [ -f pnpm-lock.yaml ]; }; then
            echo "Detected pnpm workspace at repository root"
            if [ -f pnpm-lock.yaml ]; then
              pnpm install --frozen-lockfile
            else
              pnpm install
            fi
            exit 0
          fi

          # Workspace root install: Yarn.
          if [ "$is_root_workspace" = "true" ] && [ -f yarn.lock ]; then
            echo "Detected Yarn workspace at repository root"
            yarn install --immutable || \
            yarn install --frozen-lockfile || \
            yarn install
            exit 0
          fi

          # Discover package manifests recursively.
          mapfile -t package_files < <(find . -type f -name 'package.json' \
            ! -path '*/node_modules/*' \
            ! -path '*/dist/*' \
            ! -path '*/build/*' | sort)

          declare -A package_dirs=()
          for package_file in "${package_files[@]:-}"; do
            package_dir="$(dirname "$package_file")"
            package_dirs["$package_dir"]=1
          done

          for package_dir in "${!package_dirs[@]}"; do
            echo "Installing Node.js dependencies in $package_dir"
            pushd "$package_dir" >/dev/null

            if [ -f pnpm-lock.yaml ]; then
              pnpm install --frozen-lockfile || pnpm install
            elif [ -f yarn.lock ]; then
              yarn install --immutable || \
              yarn install --frozen-lockfile || \
              yarn install
            elif [ -f package-lock.json ]; then
              npm ci
            else
              npm install
            fi

            popd >/dev/null
          done
        continue-on-error: true

      # ============================================================
      # 4) CodeQL init
      # ============================================================
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          queries: security-extended

          # Optional custom config (queries, exclusions, path filters).
          # config-file: ./.github/codeql/codeql-config.yml

          # Optional source root for nested projects.
          # source-root: src

      # ============================================================
      # 5) Build
      # ============================================================
      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      # ============================================================
      # 6) Analyze
      # ============================================================
      - name: Perform CodeQL Analysis
        id: analyze
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{ matrix.language }}"

          # Optional: fail workflow on critical findings
          # fail-on-severity: critical

      # ============================================================
      # 7) Upload artifacts
      # ============================================================
      - name: Upload CodeQL results as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: codeql-results-${{ matrix.language }}-${{ github.run_id }}

          # SARIF location can vary by runner/image.
          path: ${{ runner.temp }}/results/*.sarif

          retention-days: 30
          # Don't fail if artifacts are missing (results still go to Security tab).
          if-no-files-found: ignore

      # ============================================================
      # 8) Summary
      # ============================================================
      - name: Analysis summary
        if: always()
        shell: bash
        run: |
          echo "## ðŸ” CodeQL Analysis Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "**Language:** \`${{ matrix.language }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow:** ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.analyze.outcome }}" == "success" ]; then
            echo "**Analysis Status:** âœ… Success" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Analysis Status:** âŒ Failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          security_url="/${{ github.repository }}/security/code-scanning"
          echo "ðŸ“Š [View detailed results in Security tab]($security_url)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY

          echo "*CodeQL Version: Latest | Query Suite: security-extended*" >> $GITHUB_STEP_SUMMARY